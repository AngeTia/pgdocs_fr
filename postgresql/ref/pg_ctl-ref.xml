<?xml version="1.0" encoding="UTF-8"?>
<!-- Dernière modification
     le       $Date: 2010-05-30 19:31:13 +0200 (dim. 30 mai 2010) $
     par      $Author: gleu $
     révision $Revision: 1515 $ -->

<refentry id="app-pg-ctl">
 <refmeta>
  <refentrytitle><application>pg_ctl</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_ctl</refname>
  <refpurpose>initialiser, démarrer, arrêter ou redémarrer le serveur
  <productname>PostgreSQL</productname></refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>

   <command>pg_ctl</command>
   <arg choice="plain">init[db]</arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-o <replaceable>initdb-options</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">start</arg>
   <arg>-w</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-l <replaceable>nomfichier</replaceable></arg>
   <arg>-o <replaceable>options</replaceable></arg>
   <arg>-p <replaceable>chemin</replaceable></arg>
   <arg>-c</arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">stop</arg>
   <arg>-W</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-m
     <group choice="plain">
       <arg>s[mart]</arg>
       <arg>f[ast]</arg>
       <arg>i[mmediate]</arg>
     </group>
   </arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">restart</arg>
   <arg>-w</arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-c</arg>
   <arg>-m
     <group choice="plain">
       <arg>s[mart]</arg>
       <arg>f[ast]</arg>
       <arg>i[mmediate]</arg>
     </group>
   </arg>
   <arg>-o <replaceable>options</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">promote</arg>
   <arg>-s</arg>
   <arg>-D <replaceable>datadir</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">reload</arg>
   <arg>-s</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">status</arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">kill</arg>
   <arg><replaceable>nom_signal</replaceable></arg>
   <arg><replaceable>id_processus</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">register</arg>
   <arg>-N <replaceable>nom_service</replaceable></arg>
   <arg>-U <replaceable>nom_utilisateur</replaceable></arg>
   <arg>-P <replaceable>mot_de_passe</replaceable></arg>
   <arg>-D <replaceable>répertoire_données</replaceable></arg>
   <arg>-w</arg>
   <arg>-S
     <group choice="plain">
       <arg>a[uto]</arg>
       <arg>d[emand]</arg>
     </group>
   </arg>
   <arg>-t <replaceable>secondes</replaceable></arg>
   <arg>-o <replaceable>options</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>pg_ctl</command>
   <arg choice="plain">unregister</arg>
   <arg>-N <replaceable>nom_service</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pg-ctl-description">
  <title>Description</title>
  <indexterm zone="app-pg-ctl">
   <primary>pg_ctl</primary>
  </indexterm>

  <para>
   <application>pg_ctl</application> est un outil qui permet d'initialiser une
   instance, de démarrer, d'arrêter, ou de redémarrer un serveur <productname>PostgreSQL</productname>
   (<xref linkend="app-postgres"/>). Il permet également d'afficher le
   statut d'un serveur en cours d'exécution.
  </para>

  <para>
   Bien que le serveur puisse être démarré manuellement,
   <application>pg_ctl</application> encapsule les tâches comme la redirection
   des traces ou le détachement du terminal et du groupe de processus. Il fournit
   également des options intéressantes pour contrôler l'arrêt.
  </para>

  <para>
   Le mode <option>init</option> ou <option>initdb</option> crée une nouvelle
   grappe <productname>PostgreSQL</productname>. Une grappe est un ensemble
   de bases contrôlées par une même instance du serveur.
   Ce mode invoque la commande <command>initdb</command>.
   Voir <xref linkend="app-initdb"/> pour les détails.
  </para>

  <para>
   En mode <option>start</option>, un nouveau serveur est démarré. Le
   serveur est démarré en tâche de fond et l'entrée standard est attachée à
   <filename>/dev/null</filename> (or <literal>nul</literal> on Windows).
   On Unix-like systems, by default, the server's standard output and
   standard error are send to <application>pg_ctl</application>'s
   standard output (not standard error).  The standard output of
   <application>pg_ctl</application> should then be redirected to a
   file or piped to another process such as a log rotating program
   like <application>rotatelogs</application>; otherwise <command>postgres</command>
   will write its output to the controlling terminal (from the
   background) and will not leave the shell's process group.  On
   Windows, by default the server's standard output and standard error
   are sent to the terminal.  These default  behaviors can be changed
   by using <option>-l</option> to append server output to a log file.
   Use of either <option>-l</option> or output redirection is recommended.
  </para>

  <para>
   En mode <option>stop</option>, le serveur en cours d'exécution dans le
   répertoire indiqué est arrêté. Trois méthodes différentes d'arrêt peuvent
   être choisies avec l'option <option>-m</option>&nbsp;: le mode
   <quote>smart</quote> (the default) attend la fin de la sauvegarde en ligne (PITR) et la
   déconnexion de tous les clients. C'est la valeur par défaut.
   Si le serveur est en mode hot standby,
   la récupération et la réplication en continu sont arrêtées dès que tous les
   clients se sont déconnectés. Le mode
   <quote>fast</quote> n'attend pas la déconnexion des clients et stoppe la
   sauvegarde en ligne (PITR). Toutes les transactions actives sont
   annulées et les clients sont déconnectés. Le serveur est ensuite arrêté. Le mode
   <quote>immediate</quote> tue tous les processus serveur immédiatement,
   sans leur laisser
   la possibilité de s'arrêter proprement. Cela conduit à une récupération au redémarrage.
  </para>

  <para>
   Le mode <option>restart</option> exécute un arrêt suivi d'un
   démarrage. Ceci permet de modifier les options en ligne de commande de
   <command>postgres</command>.
  </para>

  <para>
   In <option>promote</option> mode, the standby server that is
   running in the specified data directory is commanded to exit
   recovery and begin read-write operations.
  </para>

  <para>
   Le mode <option>reload</option> envoie simplement au processus
   <command>postgres</command> un signal <systemitem>SIGHUP</systemitem>. Le
   processus relit alors ses fichiers de configuration
   (<filename>postgresql.conf</filename>, <filename>pg_hba.conf</filename>, etc.).
   Cela permet de modifier les options des fichiers de configuration qui ne
   requièrent pas un redémarrage complet pour être prises en compte.
  </para>

  <para>
   Le mode <option>status</option> vérifie si un serveur est toujours en cours
   d'exécution sur le répertoire de données indiqué. Si c'est le cas, le
   <acronym>PID</acronym> et les options en ligne de commande utilisées lors de
   son démarrage sont affichés.
  </para>

  <para>
   Le mode <option>kill</option> permet d'envoyer un signal à un processus
   spécifique. Ceci est particulièrement utile pour
   <productname>Microsoft Windows</productname>, qui ne possède pas de commande
   <application>kill</application>. <literal>--help</literal> permet d'afficher
   la liste des noms de signaux supportés.
  </para>

  <para>
   Le mode <option>register</option> permet d'enregistrer un service
   système sur <productname>Microsoft Windows</productname>. The <option>-S</option> option
   allows selection of service start type, either <quote>auto</quote> (start
   service automatically on system startup) or <quote>demand</quote> (start
   service on demand).
  </para>

  <para>
   Le mode <option>unregister</option> permet, sur
   <productname>Microsoft Windows</productname>, d'annuler un service système.
   This undoes the effects of the commande <option>register</option>.
  </para>
 </refsect1>

 <refsect1 id="app-pg-ctl-options">
  <title>Options</title>

    <variablelist>

     <varlistentry>
      <term><option>-c</option></term>
      <listitem>
       <para>
        Tente d'autoriser la création de fichiers core suite à un arrêt brutal
	du serveur, sur les plateformes où cette fonctionnalité est disponible,
	en augmentant la limite logicielle qui en dépend. C'est utile pour le
	déboguage et pour diagnostiquer des problèmes en permettant la
	récupération d'une trace de la pile d'un processus serveur en échec.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-D <replaceable class="parameter">répertoire_données</replaceable></option></term>
      <listitem>
       <para>
	Indique l'emplacement des fichiers de la base de données sur le
	système de fichiers. Si cette option est omise, la variable d'environnement
	<envar>PGDATA</envar> est utilisée.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-l <replaceable class="parameter">nomfichier</replaceable></option></term>
      <listitem>
       <para>
	Ajoute la sortie des traces du serveur dans
	<replaceable>nomfichier</replaceable>. Si le fichier n'existe pas, il
	est créé. L'<systemitem>umask</systemitem> est configuré à 077, donc l'accès au
	journal des traces est, par défaut, interdit aux autres utilisateurs.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-m <replaceable class="parameter">mode</replaceable></option></term>
      <listitem>
       <para>
	Précise le mode d'arrêt. <replaceable>mode</replaceable> peut être
	<literal>smart</literal>, <literal>fast</literal> ou
	<literal>immediate</literal>, ou la première lettre d'un de ces trois
	mots. If this is omitted, <literal>smart</literal> is used.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o <replaceable class="parameter">options</replaceable></option></term>
      <listitem>
       <para>
        Indique les options à passer directement à la commande
        <command>postgres</command>.
       </para>
       <para>
        The options should usually be surrounded by single or double
        quotes to ensure that they are passed through as a group.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o <replaceable class="parameter">initdb-options</replaceable></option></term>
      <listitem>
       <para>
        Specifies options to be passed directly to the
        <command>initdb</command> command.
       </para>
       <para>
	Ces options sont habituellement entourées par des guillemets simples
	ou doubles pour s'assurer qu'elles soient passées groupées.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable class="parameter">chemin</replaceable></option></term>
      <listitem>
       <para>
	Indique l'emplacement de l'exécutable <filename>postgres</filename>.
	Par défaut, l'exécutable <filename>postgres</filename> est pris à
	partir du même répertoire que <command>pg_ctl</command> ou, si cela
	échoue, à partir du répertoire d'installation codé en dur. Il n'est pas
	nécessaire d'utiliser cette option sauf cas inhabituel, comme lorsque des erreurs
	concernant l'impossibilité de trouver l'exécutable <filename>postgres</filename>
	apparaissent.
       </para>

       <para>
        Dans le mode <literal>init</literal>, cette option indique de manière
	analogue la localisation de l'exécutable <filename>initdb</filename>.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <listitem>
       <para>
        Affichage des seules erreurs, pas de messages d'information.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t</option></term>
      <listitem>
       <para>
        Le nombre maximum de secondes à attendre pour la fin du lancement ou de l'arrêt.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-w</option></term>
      <listitem>
       <para>
        Wait for the startup or shutdown to complete.
        Waiting is the default option for shutdowns, but not startups.
        When waiting for startup, <command>pg_ctl</command> repeatedly
        attempts to connect to the server.
        When waiting for shutdown, <command>pg_ctl</command> waits for
        the server to remove its <acronym>PID</acronym> file.
        <command>pg_ctl</command> returns an exit code based on the
        success of the startup or shutdown.
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</option></term>
      <listitem>
       <para>
	Ne pas attendre la fin du démarrage ou de l'arrêt. C'est la
	valeur par défaut pour les démarrages et redémarrages.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>

 <refsect2 id="app-pg-ctl-windows-options">
   <title>Options Windows</title>

   <variablelist>
       <varlistentry>
         <term><option>-N <replaceable class="parameter">nom_service</replaceable></option></term>
         <listitem>
           <para>
             Nom du service système à enregistrer. Le nom est utilisé à la fois
	     comme nom de service et comme nom affiché.
           </para>
         </listitem>
       </varlistentry>

       <varlistentry>
         <term><option>-U <replaceable class="parameter">nom_utilisateur</replaceable></option></term>
         <listitem>
           <para>
             Nom de l'utilisateur qui démarre le service. Pour les utilisateurs
	     identifiés sur un domaine, on utilise le format
	     <literal>DOMAIN\nom_utilisateur</literal>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
         <term><option>-P <replaceable class="parameter">mot_de_passe</replaceable></option></term>
         <listitem>
           <para>
             Mot de passe de l'utilisateur qui démarre le service.
           </para>
         </listitem>
       </varlistentry>

     <varlistentry>
     <term><option>-S <replaceable class="parameter">start-type</replaceable></option></term>
      <listitem>
       <para>
       Start type of the system service to register.  start-type can
       be <literal>auto</literal>, or <literal>demand</literal>, or
       the first letter of one of these two. If this is omitted,
       <literal>auto</literal> is used.
       </para>
      </listitem>
     </varlistentry>
   </variablelist>
 </refsect2>

 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGDATA</envar></term>

    <listitem>
     <para>
      Emplacement par défaut du répertoire des données.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   <command>pg_ctl</command>, comme la plupart des autres outils <productname>PostgreSQL</productname>,
   utilise aussi les variables d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
   For additional server variables, see <xref linkend="app-postgres"/>.
  </para>
 </refsect1>


 <refsect1>
  <title>Fichiers</title>

  <variablelist>
   <varlistentry>
    <term><filename>postmaster.pid</filename></term>

    <listitem>
     <para>
      Ce fichier, situé dans le répertoire des données, est utilisé pour
      aider <application>pg_ctl</application> à déterminer si le serveur est
      actuellement en cours d'exécution.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><filename>postmaster.opts</filename></term>

    <listitem>
     <para>Si ce fichier existe dans le répertoire des données,
      <application>pg_ctl</application> (en mode <option>restart</option>)
      passe le contenu du fichier comme options de
      <application>postgres</application>, sauf en cas de surcharge par
      l'option <option>-o</option>.
      Le contenu de ce fichier est aussi affiché en mode <option>status</option>.
     </para>
    </listitem>
   </varlistentry>

  </variablelist>
 </refsect1>


 <refsect1 id="r1-app-pgctl-2">
  <title>Exemples</title>

  <refsect2 id="r2-app-pgctl-3">
   <title>Lancer le serveur</title>

   <para>
    Démarrer un serveur&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl start</userinput>
</screen>
   </para>

   <para>
    Démarrer un serveur, avec blocage tant que le serveur n'est pas
    complètement démarré&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -w start</userinput>
</screen>
   </para>

   <para>
    To start the server using port 5433, and s'exécutant sans
    <function>fsync</function>&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -o "-F -p 5433" start</userinput>
</screen>
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-4">
   <title>Arrêt du serveur</title>
   <para>
       To stop the server, use:
<screen><prompt>$</prompt> <userinput>pg_ctl stop</userinput>
</screen>
    The <option>-m</option> option allows control over
    <emphasis>how</emphasis> the server shuts down:
<screen>
<prompt>$</prompt> <userinput>pg_ctl stop -m fast</userinput>
</screen>
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-5">
   <title>Redémarrage du serveur</title>

   <para>
    Redémarrer le serveur est pratiquement équivalent à l'arrêter puis à le
    démarrer à nouveau si ce n'est que <command>pg_ctl</command> sauvegarde et
    réutilise les options en ligne de commande qui étaient passées à
    l'instance précédente. Pour redémarrer le serveur de la façon la plus simple,
    on utilise&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl restart</userinput>
</screen>
   </para>

   <para>
    Redémarrer le serveur, en attendant l'arrêt et le redémarrage&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -w restart</userinput>
</screen>
   </para>

   <para>
    Redémarrer en utilisant le port 5433 et en désactivant
    <function>fsync</function> après redémarrage&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl -o "-F -p 5433" restart</userinput>
</screen>
   </para>
  </refsect2>

  <refsect2 id="r2-app-pgctl-6">
   <title>Affichage de l'état du serveur</title>

   <para>
    Exemple de statut affiché à partir de
    <application>pg_ctl</application>&nbsp;:
<screen><prompt>$</prompt> <userinput>pg_ctl status</userinput>
<computeroutput>
+pg_ctl: server is running (PID: 13718)
+/usr/local/pgsql/bin/postgres "-D" "/usr/local/pgsql/data" "-p" "5433" "-B" "128"</computeroutput></screen>
    C'est la ligne de commande qui sera appelée en mode redémarrage.
   </para>
  </refsect2>
 </refsect1>


 <refsect1>
  <title>Voir aussi</title>

  <simplelist type="inline">
   <member><xref linkend="app-initdb"/></member>
   <member><xref linkend="app-postgres"/></member>
  </simplelist>
 </refsect1>

</refentry>
